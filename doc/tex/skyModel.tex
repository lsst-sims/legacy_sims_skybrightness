%\documentclass[12pt,preprint]{aastex}
\documentclass{emulateapj}  %to switch to 2-column, comment out first line and uncomment 2nd line
\usepackage{url}
%\usepackage{natbib}
%\usepackage{xspace}
\def\arcsec{$^{\prime\prime}$}
\bibliographystyle{apj}
\newcommand\degree{{^\circ}}
\newcommand\surfb{$\mathrm{mag}/\square$\arcsec}
\newcommand\Gyr{\rm{~Gyr}}
\newcommand\msun{\rm{M}_\odot}
\newcommand\kms{km s$^{-1}$}
\newcommand\al{$\alpha$}
\newcommand\ha{$\rm{H}\alpha$}
\newcommand\hb{$\rm{H}\beta$}



\shorttitle{LSST Sky Model}
\shortauthors{Yoachim et al.}

\begin{document}

\title{A Sky Brightness Model for LSST}


\author{Peter Yoachim\altaffilmark{1}, author 2, author 3}

\altaffiltext{1}{Department of Astronomy, University of Washington, Box 351580,
Seattle WA, 98195; {yoachim@uw.edu} }

\begin{abstract}

\end{abstract}


\section{Introduction}

As a starting point, we use the ESO SkyCalc Sky Model Calculator\footnote{\url{http://www.eso.org/observing/etc/bin/gen/form?INS.MODE=swspectr+INS.NAME=SKYCALC}}.  This model includes scattered moonlight, scattered starlight, zodiacal light, molecular emission from the lower atmosphere, emission lines from the upper atmosphere, and airglow continuum.  


\section{The ESO Model}
Here, we briefly descibe the sky components included in the ESO model and how we have created model grids with them.



\subsection{Zodiacal Light}


\subsection{Scattered Moonlight}

\citet{Krisciunas91} provide one of the most popular models for computing the scattered moon light. This model is based on observed magnitudes from Mauna Kea. The ESO code uses the updated model of \citet{Jones13} which is fully spectroscopic and designed for Cerro Paranal. \citet{Jones13} claim their model uncertainty is $<20$\% in the optical.  Unlike the \citet{Krisciunas91} model that is a fit to observed broadband sky brightnesses, the \citet{Jones13} model uses fully 3D single scattering calculations and provides an entire spectrum.

\citet{Noll12}


\subsection{Airglow}



\subsection{Stattered Star Light}



\subsection{Atmospheric Emission Lines}

The Airglow and emission lines vary through the night and by season, but \citet{Noll12} show the variation is at the 10-20\% level.  Since LSST is a broad band survey, such mild changes in narrow emission features should not strongly effect the integrated sky background.

The airglow also correlates strongly with the solar radio flux level.  This variation results in a factor of $\sim4$ change in the flux from the minimum to maximum solar activity.  

%XXX--looking at fig 14 in  \citet{Noll12}, it looks like the emission lines should be varying with the solar flux ratio--but I thought I didn't see any variation when I plugged it into the ESO calculator.  OK, just double checked and they don't vary. Might want to check with ESO about that.




\subsection{Structure of the ESO Templates}

We save the ESO template spectra as numpy zip files.  The specta run from 300 nm to 2 microns, with 0.1 nm stepsize.

In addition to the spectra, we also pre-compute the 6 LSST magnitudes from the spectrum at each model point.

\section{Interpolating the Templates}

We combine the three components that only depend on airmass (xxx,xxx,xxx).

For all the interpolations, we weight and average the log of the template spectra.

For the Zodiacal and Lunar components, since we have placed the templates at healpix gridpoints, we can use fast healpy routines to find the 4 nearest healpixel points, along with their weights.  



\section{Observations}

XXX-describe the Cannon all-sky camera and photometry pipeline. Desceibe the photodiode data.  


\section{Additional Components}
\subsection{Twilight}

The ESO sky model does not include a component for scattered sunlight.  The twilight sky brightness is difficult to compute analytically.  While scattered moonlight can be computed via a single or double scattering model, the solar twilight comes from multiple scatterings, thus there is no simple analytic model for computing the solar twilight from first principles and models must instead rely on Monte Carlo radiative transfer simulations \citep{Patat06}.

Rather than run a lot of radiative transfer, looking at the data from the all-sky camera as well as other sites shows that after the sun's altitude is less that $\sim-10\degree$ the zenith twilight flux decays exponentially with solar altitude.

\begin{figure*}
  \plotone{../../examples/Plots/diode.pdf}
  \caption{The photodiode data.  All three photodiodes are pointed to zenith. The light gray points show individual measurements, while the yellow points are the median-binned data. The solid blue line shows the best fit exponetial decay plus constant. The green vertical line marks 12 degree twilight, and the dashed vertical blue line shows where the data was not used because the detector was often saturated at that point. \label{diodePlot}}
\end{figure*}


\begin{figure*}
  \epsscale{1}
  \plottwo{../../examples/Plots/altDecay.pdf}{../../examples/Plots/altDecayHA.pdf}
  \epsscale{1}
  \caption{Photometry from the Cannon all-sky camera, after it was been median-binned and selected for only times where the moon is down.  At low airmass (top panel), the sky brightness decays exponentially and has a small variation that is dominated by the change in airmass.  At higher airmasses, the decay is still expoential, but now is a function of both airmass and azimuth relative to the sun.}
\end{figure*}

To model the broadband flux from only the scattered twilight, we use a simple model of the form
\begin{equation}
  f^{away} = f_{z} r_{12/z} 10^{a(\alpha-12^{\circ})+b(X-1)}
\end{equation}
where $\alpha$ is the altitude of the sun, $X$ is the airmass, $f_{z}$ is the flux at zenith during dark time, and $r_{12/z}$ is the ratio of the 12-degree twilight zenith flux to the dark time zenith flux.
for the direction of the sun and airmass greater than 1.1:
\begin{equation}
  f^{toward} = f^{away}10^{c \cos{\phi}(X-1)}
\end{equation}
Where $\phi$ is the azimuthal relative to the sun. When the moon is down and the zodiacal light is negligable, we expect the total zenith flux to be $f^{tot} = f^{away} + f_{z}$.  

or in magnitudes:
\begin{eqnarray}
  m^{away} = m_0 -2.5a(\alpha-12^{\circ})-2.5b(X-1) \\
  m^{toward} = m^{away} -2.5c\cos{\phi}(X-1)
\end{eqnarray}
By default, we only apply the twilight component for solar altitudes between -11 and -20 degrees.


The best fitting parameters for $r_{12/z}$, $a$, $b$, and $c$ for each of the Canon filters are listed in Table~\ref{table:canonFits}

%>>> import lsst.sims.skybrightness as sb
%>>> twi = sb.TwilightInterp()
%>>> twi.printFitsUsed()


Filter, r_{12/z}, a (1/radians), b (1/airmass), c (az term/airmass), f_z_dark (erg/s/cm^2), m_z_dark
B [8.42181815, 22.9622121, 0.285862729, 0.299902574, 3.0479686768614231e-08] 22.35
G [4.13747072, 22.9416735, 0.297229615, 0.315696066, 5.4955415979654161e-08] 21.71
R [2.73450774, 22.2015053, 0.297825187, 0.328865935, 8.0169744510483352e-08] 21.3

u [16.0, 22.9622121, 0.285862729, 0.299902574, 2.0137729345347255e-08] 22.8
y [0.13894689, 23.41098193, 0.3, 0.3, 1.6749833701731019e-06] 18.0
z [0.74072461, 23.37634241, 0.3, 0.3, 5.0583689103990211e-07] 19.3


The paramters in Table~\ref{} do a reasonable job reproducing the observed magnitudes, we are also interested in generating the full spectrum of the sky.  For this, we assume the twilight is a modified solar spectrum.  We multiply a solar spectrum\footnote{cite source} by a low order polynomial such that it reproduces the expected broad band magnitudes.  One obvious shortcomming of this approach is that we have not included the effects of atmosphiric transmission on the twilight sky spectrum.  


\section{Validation}

XXX--make some plots of residuals vs different conditions.  Maybe the zenith sky brightness for the Cannon in all the bands--dark time, moon up, twilight.  For each one, show a histogram of the raw variation, and then the variation of raw-model.  

plan for validation:
select all the observations with alt $>85$ degrees. Median bin for observations with same mjd, I guess take a mean of the ra and dec? Then compute the RGB mags from the model.  Then plot various subsets of the residuals--all residuals, no moon or twilight, moon no twilight, twilight.

Maybe another good verification metric would be angular distance between darkest observed spot in the sky and the model darkest spot.  Could plot as contour map of moon Alt vs sun Alt.  Ooh, could scipy binned\_stat it with a median and robust RMS.


Note that we have not verified the off-zenith IR performance of the model.  

\section{Speed Testing}



\section{What's Not Included}

There are several things that, in theory, could be used to better refine the returned sky spectrum.

blahblah, the IR sky is known to be variable on short timescales.

blahblah, emission lines are brighter right after sunset and before sunrise.

Clouds are complicated since they can block some sources of sky background while also reflecting other components.  


\bibliography{skyModel.bib}
\end{document}
